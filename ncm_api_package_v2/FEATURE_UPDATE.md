# 功能更新说明

## 新增功能

### 1. API访问Hash值 🔑

**功能描述**：
- 访问密码验证成功后，系统会返回该密码对应的唯一Hash值
- 该Hash值可用于API调用时的身份验证，避免在URL中暴露明文密码

**使用方式**：

1. **登录页面**：
   - 输入访问密码并验证成功后，页面会显示API访问Hash
   - 可点击"复制"按钮快速复制Hash值
   - 3秒后自动跳转到主界面

2. **主界面**：
   - 在"登录管理"标签页的"访问密码管理"区域
   - 系统会自动加载并显示当前密码的Hash值
   - 可随时复制用于API调用

3. **API调用示例**：
   ```
   # 原方式（不推荐）
   /video?id=123456&password=ncm2024
   
   # 新方式（推荐）
   /video?id=123456&hash=a1b2c3d4e5f6...
   ```

**技术实现**：
- 使用SHA-256算法对密码进行哈希
- 每个密码对应唯一的Hash值
- Hash值存储在浏览器Cookie中，持续30天

---

### 2. 扫码登录超时限制 ⏱️

**功能描述**：
- QR码扫码登录现在有60次轮询限制（每2秒检查一次，共120秒）
- 超时后自动停止轮询，避免服务器资源浪费

**用户体验改进**：
- 轮询过程中实时显示剩余时间：`⏳ 等待扫码中... (XX秒后超时)`
- 超时后显示明确提示：`⏱️ 登录超时，请刷新二维码重试`
- 避免无限轮询导致的服务器负载

**技术参数**：
- 轮询间隔：2秒
- 最大轮询次数：60次
- 总超时时间：120秒（2分钟）

---

## 代码变更

### 修改的文件：

1. **ncm/utils/access_password.py**
   - 添加 `get_password_hash(password)` 公开方法

2. **ncm/api/routes.py**
   - 导入 `Form` 用于接收表单数据
   - `/auth/verify` 端点返回 `hash` 字段
   - 使用 `Form(...)` 修复422错误

3. **ncm/api/web_ui.py**
   - 主界面添加API Hash显示区域
   - 登录页面添加Hash显示和复制功能
   - QR登录添加60次超时限制和倒计时显示
   - 添加 `loadApiHash()` 和 `copyApiHash()` 函数

---

## 测试建议

### 测试API Hash功能：
1. 清除浏览器Cookie
2. 访问系统登录页面
3. 输入正确密码（默认：ncm2024）
4. 验证Hash值是否显示
5. 复制Hash值并测试API调用

### 测试扫码登录超时：
1. 进入"登录管理"标签
2. 点击"扫码登录"
3. 不进行扫码操作
4. 观察倒计时显示（120秒后应显示超时提示）

---

## 安全性说明

- Hash值使用SHA-256算法生成，单向不可逆
- 即使Hash值泄露，也无法反推出原始密码
- 建议在公网环境下优先使用Hash而非明文密码
- Cookie使用httponly标志，防止XSS攻击

---

**更新日期**：2026年1月8日
**版本**：v1.1.0
