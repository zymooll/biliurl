# ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•åŠŸèƒ½è¯´æ˜

## ğŸ‰ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå°† `getcookie.py` ä¸­çš„ç™»å½•é€»è¾‘é›†æˆåˆ° API ä¸­ï¼Œç°åœ¨æ”¯æŒåœ¨ç½‘é¡µç«¯ä¸€é”®ç™»å½•ï¼Œå¹¶ä¸” Cookie å¯ä»¥åœ¨æ‰€æœ‰çº¿ç¨‹é—´å…±äº«ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

### 1. å¤šç§ç™»å½•æ–¹å¼
- **æ‰«ç ç™»å½•**ï¼šä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹ APP æ‰«æäºŒç»´ç ç™»å½•ï¼ˆæœ€æ¨èï¼‰
- **çŸ­ä¿¡éªŒè¯ç ç™»å½•**ï¼šé€šè¿‡æ‰‹æœºå·æ¥æ”¶éªŒè¯ç ç™»å½•
- **å¯†ç ç™»å½•**ï¼šä½¿ç”¨æ‰‹æœºå·å’Œå¯†ç ç›´æ¥ç™»å½•
- **Cookie å¯¼å…¥**ï¼šæ‰‹åŠ¨å¯¼å…¥å·²æœ‰çš„ Cookie

### 2. çº¿ç¨‹å®‰å…¨çš„ Cookie ç®¡ç†
- ä½¿ç”¨ `threading.RLock` å®ç°çº¿ç¨‹å®‰å…¨
- Cookie è‡ªåŠ¨ç¼“å­˜ï¼Œå‡å°‘æ–‡ä»¶ I/O
- æ”¯æŒå¤šçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œä¸ä¼šäº§ç”Ÿç«æ€æ¡ä»¶

### 3. Web UI é›†æˆ
- ç°ä»£åŒ–çš„ç”¨æˆ·ç•Œé¢
- å®æ—¶æ˜¾ç¤ºç™»å½•çŠ¶æ€
- æ”¯æŒæ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨æœåŠ¡

```bash
cd ncm_api_package_v2
python run_server.py
```

### è®¿é—® Web UI

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000`ï¼ˆæˆ–é…ç½®çš„ç«¯å£ï¼‰

### ç™»å½•æ­¥éª¤

1. ç‚¹å‡»é¡µé¢åº•éƒ¨çš„ **"ç™»å½•ç®¡ç†"** æ ‡ç­¾
2. é€‰æ‹©ä½ å–œæ¬¢çš„ç™»å½•æ–¹å¼ï¼š
   - **æ‰«ç ç™»å½•**ï¼šè‡ªåŠ¨ç”ŸæˆäºŒç»´ç ï¼Œç”¨ç½‘æ˜“äº‘éŸ³ä¹ APP æ‰«æå³å¯
   - **çŸ­ä¿¡ç™»å½•**ï¼šè¾“å…¥æ‰‹æœºå· â†’ ç‚¹å‡»"å‘é€éªŒè¯ç " â†’ è¾“å…¥éªŒè¯ç  â†’ ç‚¹å‡»"ç™»å½•"
   - **å¯†ç ç™»å½•**ï¼šè¾“å…¥æ‰‹æœºå·å’Œå¯†ç  â†’ ç‚¹å‡»"ç™»å½•"
   - **Cookie å¯¼å…¥**ï¼šç²˜è´´å®Œæ•´çš„ Cookie å­—ç¬¦ä¸² â†’ ç‚¹å‡»"å¯¼å…¥ Cookie"

3. ç™»å½•æˆåŠŸåï¼ŒçŠ¶æ€æ ä¼šæ˜¾ç¤ºä½ çš„æ˜µç§°å’Œ UID
4. Cookie ä¼šè‡ªåŠ¨ä¿å­˜åˆ° `cookie.json` æ–‡ä»¶ä¸­

## ğŸ”§ API æ¥å£

### ç™»å½•ç›¸å…³æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/login/qr/key` | GET | è·å–æ‰«ç ç™»å½•çš„ Key |
| `/login/qr/create` | GET | ç”ŸæˆäºŒç»´ç å›¾ç‰‡ï¼ˆbase64ï¼‰ |
| `/login/qr/check` | GET | æ£€æŸ¥æ‰«ç çŠ¶æ€ |
| `/login/sms/send` | POST | å‘é€çŸ­ä¿¡éªŒè¯ç  |
| `/login/sms/verify` | POST | çŸ­ä¿¡éªŒè¯ç ç™»å½• |
| `/login/password` | POST | æ‰‹æœºå·å¯†ç ç™»å½• |
| `/cookie/import` | POST | æ‰‹åŠ¨å¯¼å…¥ Cookie |
| `/cookie/refresh` | GET | åˆ·æ–° Cookie ç¼“å­˜ |
| `/user/info` | GET | è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ |
| `/logout` | GET | é€€å‡ºç™»å½• |

### ä½¿ç”¨ç¤ºä¾‹

#### æ‰«ç ç™»å½•å®Œæ•´æµç¨‹

```python
import requests
import time

base_url = "http://localhost:3000"

# 1. è·å– QR Key
key_response = requests.get(f"{base_url}/login/qr/key")
qr_key = key_response.json()["unikey"]

# 2. è·å–äºŒç»´ç å›¾ç‰‡
qr_response = requests.get(f"{base_url}/login/qr/create?key={qr_key}")
qr_img_base64 = qr_response.json()["qrimg"]
print(f"è¯·æ‰«æäºŒç»´ç ï¼š{qr_img_base64}")

# 3. è½®è¯¢æ£€æŸ¥æ‰«ç çŠ¶æ€
while True:
    check_response = requests.get(f"{base_url}/login/qr/check?key={qr_key}")
    data = check_response.json()
    
    if data["code"] == 800:
        print("äºŒç»´ç å·²è¿‡æœŸ")
        break
    elif data["code"] == 801:
        print("ç­‰å¾…æ‰«ç ...")
    elif data["code"] == 802:
        print("å·²æ‰«ç ï¼Œè¯·ç¡®è®¤...")
    elif data["code"] == 803:
        print("ç™»å½•æˆåŠŸï¼")
        cookie = data.get("cookie")
        break
    
    time.sleep(2)
```

#### çŸ­ä¿¡éªŒè¯ç ç™»å½•

```python
# 1. å‘é€éªŒè¯ç 
requests.post(f"{base_url}/login/sms/send?phone=13800138000")

# 2. è¾“å…¥éªŒè¯ç å¹¶ç™»å½•
captcha = input("è¯·è¾“å…¥éªŒè¯ç ï¼š")
response = requests.post(
    f"{base_url}/login/sms/verify?phone=13800138000&captcha={captcha}"
)
print(response.json())
```

#### å¯†ç ç™»å½•

```python
response = requests.post(
    f"{base_url}/login/password?phone=13800138000&password=yourpassword"
)
print(response.json())
```

## ğŸ’¾ Cookie ç®¡ç†å™¨

æ–°çš„ `CookieManager` ç±»æä¾›äº†çº¿ç¨‹å®‰å…¨çš„ Cookie ç®¡ç†ï¼š

```python
from ncm.utils.cookie import CookieManager

# ä¿å­˜ Cookieï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
CookieManager.save_cookie("your_cookie_string")

# åŠ è½½ Cookieï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰
cookie = CookieManager.load_cookie()

# åˆ·æ–°ç¼“å­˜ï¼ˆä»æ–‡ä»¶é‡æ–°åŠ è½½ï¼‰
cookie = CookieManager.refresh_cache()

# æ¸…é™¤ Cookie
CookieManager.clear_cookie()
```

### çº¿ç¨‹å®‰å…¨ç‰¹æ€§

- ä½¿ç”¨ `threading.RLock` å®ç°å¯é‡å…¥é”
- Cookie è‡ªåŠ¨ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå‡å°‘ç£ç›˜ I/O
- æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å– Cookie
- å†™å…¥æ“ä½œè‡ªåŠ¨åŠ é”ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§

## ğŸ” å®‰å…¨å»ºè®®

1. **ä¸è¦å…¬å¼€ä½ çš„ Cookie**ï¼šCookie åŒ…å«ä½ çš„ç™»å½•å‡­è¯ï¼Œä¸è¦åˆ†äº«ç»™ä»–äºº
2. **å®šæœŸæ›´æ¢å¯†ç **ï¼šå¦‚æœä½¿ç”¨å¯†ç ç™»å½•ï¼Œå»ºè®®å®šæœŸæ›´æ¢å¯†ç 
3. **ä½¿ç”¨æ‰«ç ç™»å½•**ï¼šæ‰«ç ç™»å½•æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ï¼Œæ¨èä¼˜å…ˆä½¿ç”¨
4. **ä¿æŠ¤ `cookie.json` æ–‡ä»¶**ï¼šè¿™ä¸ªæ–‡ä»¶åŒ…å«ä½ çš„ç™»å½•ä¿¡æ¯ï¼Œä¸è¦ä¸Šä¼ åˆ°å…¬å¼€ä»“åº“

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šäºŒç»´ç æ— æ³•åŠ è½½
- æ£€æŸ¥ç½‘æ˜“äº‘éŸ³ä¹ API æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆé»˜è®¤ `http://localhost:3002`ï¼‰
- æŸ¥çœ‹ `ncm/config.py` ä¸­çš„ `API_BASE_URL` é…ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜ï¼šç™»å½•åæ˜¾ç¤ºæœªç™»å½•
- ç‚¹å‡»"åˆ·æ–° Cookie ç¼“å­˜"æŒ‰é’®
- æˆ–è°ƒç”¨ `/cookie/refresh` æ¥å£

### é—®é¢˜ï¼šå¤šçº¿ç¨‹ä¸‹ Cookie ä¸åŒæ­¥
- Cookie ä½¿ç”¨å…¨å±€ç¼“å­˜æœºåˆ¶ï¼Œåº”è¯¥è‡ªåŠ¨åŒæ­¥
- å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯ä»¥è°ƒç”¨ `CookieManager.refresh_cache()` å¼ºåˆ¶åˆ·æ–°

### é—®é¢˜ï¼šçŸ­ä¿¡éªŒè¯ç æœªæ”¶åˆ°
- æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦æ­£ç¡®
- ç¡®è®¤çŸ­ä¿¡æ²¡æœ‰è¢«æ‹¦æˆª
- ç­‰å¾… 60 ç§’åé‡è¯•

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨

1. **ncm/core/login.py**
   - æ–°å¢ `sendSMS()` - å‘é€çŸ­ä¿¡éªŒè¯ç 
   - æ–°å¢ `verifySMS()` - éªŒè¯çŸ­ä¿¡å¹¶ç™»å½•
   - æ–°å¢ `PhonePasswordLogin()` - å¯†ç ç™»å½•

2. **ncm/utils/cookie.py**
   - æ–°å¢ `CookieManager` ç±» - çº¿ç¨‹å®‰å…¨çš„ Cookie ç®¡ç†å™¨
   - å®ç°å…¨å±€ Cookie ç¼“å­˜æœºåˆ¶
   - ä½¿ç”¨ `threading.RLock` ä¿è¯çº¿ç¨‹å®‰å…¨

3. **ncm/api/routes.py**
   - æ–°å¢ `/login/sms/send` - å‘é€éªŒè¯ç 
   - æ–°å¢ `/login/sms/verify` - çŸ­ä¿¡ç™»å½•
   - æ–°å¢ `/login/password` - å¯†ç ç™»å½•
   - æ–°å¢ `/cookie/import` - å¯¼å…¥ Cookie
   - æ–°å¢ `/cookie/refresh` - åˆ·æ–°ç¼“å­˜

4. **ncm/api/web_ui.py**
   - æ–°å¢"ç™»å½•ç®¡ç†"æ ‡ç­¾é¡µ
   - å®ç°å®Œæ•´çš„ç™»å½• UI ç•Œé¢
   - æ·»åŠ ç™»å½•çŠ¶æ€æ˜¾ç¤º
   - å®ç°è‡ªåŠ¨æ‰«ç ã€çŸ­ä¿¡ã€å¯†ç ç­‰å¤šç§ç™»å½•æ–¹å¼

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ·»åŠ è®°ä½ç™»å½•çŠ¶æ€åŠŸèƒ½
- [ ] å®ç°è‡ªåŠ¨ç»­æœŸæœºåˆ¶
- [ ] æ·»åŠ å¤šè´¦å·åˆ‡æ¢åŠŸèƒ½
- [ ] å¢åŠ ç™»å½•å†å²è®°å½•

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªåŸé¡¹ç›®çš„è®¸å¯è¯ã€‚

---

**Happy Coding! ğŸµ**
