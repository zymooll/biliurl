# 用户绑定功能说明

## 功能概述

新增了用户绑定功能，允许用户设置自己的用户名，系统会自动记住该用户最后播放的歌曲ID。

## 使用方法

### 1. 设置用户名

1. 打开网页后，点击右上角的**用户图标**按钮（在主题切换按钮左侧）
2. 在弹出的面板中输入您的用户名（最多20个字符）
3. 点击"保存"按钮

用户名会保存在浏览器的 Cookie 中，有效期为365天。

### 2. 清除用户名

在用户绑定面板中点击"清除"按钮即可删除已保存的用户名。

## 工作原理

### 前端实现

- **Cookie 存储**: 用户名保存在名为 `ncm_user` 的 Cookie 中
- **自动添加参数**: 所有视频请求会自动添加 `user=你的用户名` 参数
- **UI 反馈**: 保存后会在面板中显示当前绑定的用户名

### 后端实现

- **ID 绑定**: 当服务器收到包含 `id` 和 `user` 的请求时，会保存该用户与歌曲ID的绑定关系
- **自动使用**: 当服务器收到只包含 `user` 参数（不含 `id`）的请求时，会自动使用之前该用户绑定的ID

## 使用示例

### 场景1: 第一次播放
```
用户: zymooll
请求: /video?id=123&user=zymooll
→ 服务器保存: zymooll → 123
→ 播放歌曲 123
```

### 场景2: 再次播放同一首歌
```
用户: zymooll
请求: /video?user=zymooll
→ 服务器查找: zymooll → 123
→ 自动播放歌曲 123
```

### 场景3: 播放新歌曲
```
用户: zymooll
请求: /video?id=456&user=zymooll
→ 服务器更新: zymooll → 456
→ 播放歌曲 456
```

## API 使用

如果您通过 API 直接调用，可以手动添加 `user` 参数：

```bash
# 绑定并播放
curl "http://localhost:8000/video?id=123&user=zymooll&access_hash=your_hash"

# 使用绑定的ID播放
curl "http://localhost:8000/video?user=zymooll&access_hash=your_hash"
```

## 技术细节

### 文件修改清单

1. **index.html**
   - 添加了用户绑定按钮（用户图标）
   - 添加了用户面板UI组件

2. **main.css**
   - 添加了 `.user-toggle` 按钮样式
   - 添加了 `.user-panel` 面板样式
   - 添加了滑入动画效果

3. **app.js**
   - 添加了 Cookie 操作函数（`getCookie`, `setCookie`）
   - 添加了用户管理函数（`getUser`, `saveUser`, `clearUser`）
   - 添加了 `toggleUserPanel` 切换面板显示
   - 添加了 `addUserParam` 在请求中自动添加用户参数
   - 添加了点击外部关闭面板的功能

4. **routes.py**
   - 添加了 `user_id_bindings` 字典存储用户绑定
   - 修改了 `/video` 端点，添加 `user` 参数
   - 实现了用户与ID的绑定逻辑

## 注意事项

1. **内存存储**: 用户绑定关系存储在服务器内存中，重启服务器后会丢失
2. **Cookie 有效期**: 前端用户名 Cookie 有效期为365天
3. **多用户支持**: 不同用户可以有各自独立的ID绑定
4. **无需密码**: 用户绑定不需要密码，仅基于用户名标识

## 未来改进建议

如需持久化存储用户绑定关系，可以考虑：

1. 使用 SQLite 数据库存储绑定关系
2. 使用 Redis 缓存用户绑定
3. 添加用户认证机制
4. 支持用户播放历史记录
