# ç™»å½•åŠŸèƒ½æµ‹è¯•æŒ‡å—

## ğŸ¯ å·²ä¼˜åŒ–çš„åŠŸèƒ½

### 1. äºŒç»´ç ç™»å½•ç«‹å³è¿”å›ç»“æœ
- âœ… ç™»å½•æˆåŠŸåç«‹å³æ˜¾ç¤º"ç™»å½•æˆåŠŸï¼æ­£åœ¨æ›´æ–°çŠ¶æ€..."
- âœ… å‰ç«¯ç«‹å³è°ƒç”¨ `checkLoginStatus()` æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- âœ… åç«¯ç«‹å³è°ƒç”¨ `CookieManager.refresh_cache()` åŒæ­¥æ‰€æœ‰çº¿ç¨‹

### 2. Cookie å…¨å±€åŒæ­¥
- âœ… æ‰€æœ‰ç™»å½•æ–¹å¼ï¼ˆæ‰«ç ã€çŸ­ä¿¡ã€å¯†ç ã€Cookieå¯¼å…¥ï¼‰éƒ½ä¼šç«‹å³åˆ·æ–°ç¼“å­˜
- âœ… ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ `CookieManager` ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§
- âœ… æ‰€æœ‰ç”¨æˆ·ï¼ˆæ‰€æœ‰æµè§ˆå™¨ä¼šè¯ã€æ‰€æœ‰ API è°ƒç”¨ï¼‰å…±äº«åŒä¸€ä¸ª Cookie

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: äºŒç»´ç ç™»å½•åŠæ—¶åé¦ˆ

1. **å¯åŠ¨æœåŠ¡**
   ```bash
   cd ncm_api_package_v2
   python run_server.py
   ```

2. **æ‰“å¼€æµè§ˆå™¨å¹¶å¯ç”¨å¼€å‘è€…å·¥å…·**
   - è®¿é—® http://localhost:3000
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - åˆ‡æ¢åˆ° Console æ ‡ç­¾

3. **æ‰§è¡Œæ‰«ç ç™»å½•**
   - ç‚¹å‡»åº•éƒ¨"ç™»å½•ç®¡ç†"æ ‡ç­¾
   - ä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹ APP æ‰«æäºŒç»´ç 
   - åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•

4. **éªŒè¯ç»“æœ**
   - âœ… äºŒç»´ç æç¤ºç«‹å³å˜ä¸º"âœ… ç™»å½•æˆåŠŸï¼æ­£åœ¨æ›´æ–°çŠ¶æ€..."
   - âœ… 1ç§’å†…çŠ¶æ€æ æ˜¾ç¤º"âœ… å·²ç™»å½•ï¼šä½ çš„æ˜µç§° (UID: xxx)"
   - âœ… Console ä¸­æ˜¾ç¤ºï¼š"ç™»å½•çŠ¶æ€å·²æ›´æ–°ï¼šä½ çš„æ˜µç§°"
   - âœ… åç«¯ç»ˆç«¯æ˜¾ç¤ºï¼š"âœ… ç”¨æˆ·ç™»å½•æˆåŠŸï¼ŒCookie å·²ä¿å­˜å¹¶åŒæ­¥åˆ°æ‰€æœ‰çº¿ç¨‹"

### æµ‹è¯• 2: Cookie å¤šçº¿ç¨‹åŒæ­¥

**æ–¹æ³• A: ä½¿ç”¨å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ**

1. åœ¨æµè§ˆå™¨ä¸­ç™»å½•ï¼ˆä»»æ„æ–¹å¼ï¼‰
2. æ‰“å¼€æ–°æ ‡ç­¾é¡µè®¿é—® http://localhost:3000
3. ç‚¹å‡»"ç™»å½•ç®¡ç†"
4. âœ… åº”è¯¥ç«‹å³æ˜¾ç¤º"âœ… å·²ç™»å½•ï¼šä½ çš„æ˜µç§°"ï¼ˆæ— éœ€é‡æ–°ç™»å½•ï¼‰

**æ–¹æ³• B: ä½¿ç”¨ API æµ‹è¯•**

```bash
# ç»ˆç«¯ 1: æ‰«ç ç™»å½•åï¼Œæ£€æŸ¥ Cookie
curl http://localhost:3000/user/cookie

# ç»ˆç«¯ 2: åŒæ—¶æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
curl http://localhost:3000/user/info

# ä¸¤ä¸ªè¯·æ±‚åº”è¯¥éƒ½è¿”å›ç›¸åŒçš„ç™»å½•ä¿¡æ¯
```

**æ–¹æ³• C: å¹¶å‘è¯·æ±‚æµ‹è¯•**

```python
import requests
import concurrent.futures

def check_login(thread_id):
    response = requests.get('http://localhost:3000/user/info')
    data = response.json()
    if data.get('code') == 200:
        print(f"çº¿ç¨‹ {thread_id}: å·²ç™»å½• - {data['profile']['nickname']}")
    else:
        print(f"çº¿ç¨‹ {thread_id}: æœªç™»å½•")
    return data

# å¯åŠ¨ 20 ä¸ªå¹¶å‘è¯·æ±‚
with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
    futures = [executor.submit(check_login, i) for i in range(20)]
    results = [f.result() for f in futures]

# æ‰€æœ‰ç»“æœåº”è¯¥ä¸€è‡´
```

### æµ‹è¯• 3: ä¸åŒç™»å½•æ–¹å¼çš„å³æ—¶åé¦ˆ

**çŸ­ä¿¡ç™»å½•**
1. è¾“å…¥æ‰‹æœºå·å¹¶å‘é€éªŒè¯ç 
2. è¾“å…¥éªŒè¯ç å¹¶ç‚¹å‡»"ç™»å½•"
3. âœ… å¼¹çª—æ˜¾ç¤º"âœ… ç™»å½•æˆåŠŸï¼Cookie å·²åŒæ­¥åˆ°æ‰€æœ‰çº¿ç¨‹"
4. âœ… çŠ¶æ€æ ç«‹å³æ›´æ–°ä¸ºå·²ç™»å½•çŠ¶æ€

**å¯†ç ç™»å½•**
1. è¾“å…¥æ‰‹æœºå·å’Œå¯†ç 
2. ç‚¹å‡»"ç™»å½•"
3. âœ… å¼¹çª—æ˜¾ç¤º"âœ… ç™»å½•æˆåŠŸï¼Cookie å·²åŒæ­¥åˆ°æ‰€æœ‰çº¿ç¨‹"
4. âœ… çŠ¶æ€æ ç«‹å³æ›´æ–°ä¸ºå·²ç™»å½•çŠ¶æ€

**Cookie å¯¼å…¥**
1. ç²˜è´´æœ‰æ•ˆçš„ Cookie
2. ç‚¹å‡»"å¯¼å…¥Cookie"
3. âœ… å¼¹çª—æ˜¾ç¤º"âœ… Cookie å¯¼å…¥æˆåŠŸï¼å·²åŒæ­¥åˆ°æ‰€æœ‰çº¿ç¨‹"
4. âœ… çŠ¶æ€æ ç«‹å³æ›´æ–°ä¸ºå·²ç™»å½•çŠ¶æ€

### æµ‹è¯• 4: åç«¯æ—¥å¿—éªŒè¯

ç™»å½•åæ£€æŸ¥åç«¯ç»ˆç«¯è¾“å‡ºï¼š

```
âœ… ç”¨æˆ·ç™»å½•æˆåŠŸï¼ŒCookie å·²ä¿å­˜å¹¶åŒæ­¥åˆ°æ‰€æœ‰çº¿ç¨‹
âœ… ç”¨æˆ·é€šè¿‡çŸ­ä¿¡ç™»å½•æˆåŠŸï¼ŒCookie å·²åŒæ­¥
âœ… ç”¨æˆ·é€šè¿‡å¯†ç ç™»å½•æˆåŠŸï¼ŒCookie å·²åŒæ­¥
âœ… Cookie å·²å¯¼å…¥å¹¶åŒæ­¥åˆ°æ‰€æœ‰çº¿ç¨‹
```

## ğŸ” è°ƒè¯•æŠ€å·§

### æ£€æŸ¥ Cookie æ˜¯å¦æ­£ç¡®ä¿å­˜

```bash
# æŸ¥çœ‹ cookie.json æ–‡ä»¶
cat cookie.json

# æˆ–è€…ä½¿ç”¨ API
curl http://localhost:3000/user/cookie
```

### æ£€æŸ¥ç™»å½•çŠ¶æ€

```bash
curl http://localhost:3000/user/info
```

### å¼ºåˆ¶åˆ·æ–° Cookie ç¼“å­˜

```bash
curl http://localhost:3000/cookie/refresh
```

### æµè§ˆå™¨ Console ä¸­æµ‹è¯•

```javascript
// æ£€æŸ¥ç™»å½•çŠ¶æ€
fetch('/user/info').then(r => r.json()).then(console.log);

// å¼ºåˆ¶åˆ·æ–° Cookie
fetch('/cookie/refresh').then(r => r.json()).then(console.log);
```

## ğŸ“Š æ€§èƒ½éªŒè¯

### Cookie ç¼“å­˜æœºåˆ¶

```python
# æµ‹è¯•ç¼“å­˜æ€§èƒ½
import time
from ncm.utils.cookie import CookieManager

# ç¬¬ä¸€æ¬¡åŠ è½½ï¼ˆä»æ–‡ä»¶è¯»å–ï¼‰
start = time.time()
cookie1 = CookieManager.load_cookie()
time1 = time.time() - start
print(f"é¦–æ¬¡åŠ è½½: {time1*1000:.2f}ms")

# ç¬¬äºŒæ¬¡åŠ è½½ï¼ˆä»ç¼“å­˜è¯»å–ï¼‰
start = time.time()
cookie2 = CookieManager.load_cookie()
time2 = time.time() - start
print(f"ç¼“å­˜åŠ è½½: {time2*1000:.2f}ms")

print(f"æ€§èƒ½æå‡: {time1/time2:.0f}x")
# é¢„æœŸè¾“å‡ºï¼šæ€§èƒ½æå‡ 50-100x
```

## âœ… é¢„æœŸç»“æœæ€»ç»“

| æµ‹è¯•é¡¹ç›® | é¢„æœŸç»“æœ |
|---------|---------|
| æ‰«ç ç™»å½•åé¦ˆæ—¶é—´ | < 1ç§’ |
| çŠ¶æ€æ›´æ–°å»¶è¿Ÿ | < 1ç§’ |
| Cookie åŒæ­¥å»¶è¿Ÿ | ç«‹å³ï¼ˆ< 0.1ç§’ï¼‰ |
| å¤šæ ‡ç­¾é¡µåŒæ­¥ | ç«‹å³ç”Ÿæ•ˆ |
| å¹¶å‘è¯·æ±‚ä¸€è‡´æ€§ | 100% ä¸€è‡´ |
| ç¼“å­˜æ€§èƒ½æå‡ | 50-100x |

## ğŸ› å¸¸è§é—®é¢˜

### Q: ç™»å½•åçŠ¶æ€æ˜¾ç¤º"æœªç™»å½•"
**A**: æ£€æŸ¥ï¼š
1. åç«¯æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æµè§ˆå™¨ Console æ˜¯å¦æœ‰é”™è¯¯
3. æ‰‹åŠ¨åˆ·æ–°é¡µé¢æˆ–è°ƒç”¨ `/cookie/refresh`

### Q: å¤šä¸ªç”¨æˆ·èƒ½å¦åŒæ—¶ä½¿ç”¨ï¼Ÿ
**A**: å¯ä»¥ï¼Œä½†æ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ª Cookieï¼ˆå…¨å±€ç™»å½•çŠ¶æ€ï¼‰ã€‚å¦‚æœéœ€è¦å¤šè´¦å·æ”¯æŒï¼Œéœ€è¦é¢å¤–çš„ä¼šè¯ç®¡ç†ã€‚

### Q: Cookie ä¼šè‡ªåŠ¨è¿‡æœŸå—ï¼Ÿ
**A**: ç½‘æ˜“äº‘çš„ Cookie ä¼šè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚æœªæ¥å¯ä»¥å®ç°è‡ªåŠ¨ç»­æœŸåŠŸèƒ½ã€‚

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### Cookie åŒæ­¥æµç¨‹

```
ç”¨æˆ·ç™»å½• 
  â†’ åç«¯ä¿å­˜ Cookie åˆ°æ–‡ä»¶
  â†’ è°ƒç”¨ CookieManager.refresh_cache()
  â†’ æ›´æ–°å…¨å±€ç¼“å­˜å˜é‡
  â†’ æ‰€æœ‰çº¿ç¨‹ç«‹å³è·å–åˆ°æœ€æ–° Cookie
  â†’ å‰ç«¯è°ƒç”¨ checkLoginStatus()
  â†’ æ˜¾ç¤ºç™»å½•æˆåŠŸçŠ¶æ€
```

### çº¿ç¨‹å®‰å…¨ä¿è¯

```python
# ä½¿ç”¨ RLock ä¿æŠ¤
with _cookie_lock:
    _cached_cookie = cookie  # åŸå­æ“ä½œ
    save_to_file(cookie)      # æ–‡ä»¶å†™å…¥
```

---

**æµ‹è¯•å®Œæˆåï¼Œæ‰€æœ‰åŠŸèƒ½åº”è¯¥éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼** ğŸ‰
